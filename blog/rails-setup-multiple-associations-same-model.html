<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Ruby on Rails: Setup multiple associations with the same model | Emmanuel Corrales
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/poole.css">
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/syntax.css">
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/hyde.css">
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/cheatsheet.css">
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/sidebar.css">
  
    <link rel="stylesheet" href="https://emcorrales.com/assets/css/posts.css">
  
  <link rel="stylesheet" href="https://emcorrales.com/vendor/font-awesome/5.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="57x57" href="https://emcorrales.com/assets/images/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://emcorrales.com/assets/images/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://emcorrales.com/assets/images/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://emcorrales.com/assets/images/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://emcorrales.com/assets/images/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://emcorrales.com/assets/images/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://emcorrales.com/assets/images/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://emcorrales.com/assets/images/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://emcorrales.com/assets/images/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="https://emcorrales.com/assets/images/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://emcorrales.com/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://emcorrales.com/assets/images/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://emcorrales.com/assets/images/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="https://emcorrales.com/assets/images/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://emcorrales.com/feed.xml">

  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-80537045-1', 'auto');
    ga('send', 'pageview');
  </script>
  

  <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Ruby on Rails: Setup multiple associations with the same model | Emmanuel Corrales</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Ruby on Rails: Setup multiple associations with the same model" />
<meta name="author" content="Emmanuel Corrales" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="When I was just starting to learn Ruby on Rails, I had trouble setting up multiple associations with the same model due to my lack of understanding and reliance on Rail’s “magical” generators. Here I’ll show you how to implement it and analyze how it happens. On this example there are two models, User and TransferRequest. TransferRequest has attributes sender and receiver which are instances of User." />
<meta property="og:description" content="When I was just starting to learn Ruby on Rails, I had trouble setting up multiple associations with the same model due to my lack of understanding and reliance on Rail’s “magical” generators. Here I’ll show you how to implement it and analyze how it happens. On this example there are two models, User and TransferRequest. TransferRequest has attributes sender and receiver which are instances of User." />
<link rel="canonical" href="https://emcorrales.com/blog/rails-setup-multiple-associations-same-model" />
<meta property="og:url" content="https://emcorrales.com/blog/rails-setup-multiple-associations-same-model" />
<meta property="og:site_name" content="Emmanuel Corrales" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-04-04T09:06:33+00:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Emmanuel Corrales"},"description":"When I was just starting to learn Ruby on Rails, I had trouble setting up multiple associations with the same model due to my lack of understanding and reliance on Rail’s “magical” generators. Here I’ll show you how to implement it and analyze how it happens. On this example there are two models, User and TransferRequest. TransferRequest has attributes sender and receiver which are instances of User.","headline":"Ruby on Rails: Setup multiple associations with the same model","dateModified":"2018-04-04T09:06:33+00:00","datePublished":"2018-04-04T09:06:33+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://emcorrales.com/blog/rails-setup-multiple-associations-same-model"},"url":"https://emcorrales.com/blog/rails-setup-multiple-associations-same-model","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <img src="https://www.gravatar.com/avatar/6b917878b9fccb87c8b1489813b755e2?s=500" alt="Emmanuel Corrales" />
      <h1>
        <a href="https://emcorrales.com">
          Emmanuel Corrales
        </a>
      </h1>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="https://emcorrales.com">Blog</a>

      

      
      
        
      
        
          
        
      
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/cheatsheets">Cheat Sheets</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about">About</a>
          
        
      
    </nav>

    <div class="social-icons">
      <a href="https://twitter.com/em_corrales"
        class="social fab fa-twitter" title="Twitter" target="_blank"></a>

      <a href="https://linkedin.com/in/emmanuelcorrales"
        class="social fab fa-linkedin" title="Linkedin" target="_blank"></a>

      <a href="https://github.com/emcorrales"
        class="social fab fa-github" title="Github" target="_blank"></a>

      <a href="mailto:contact@emcorrales.com" class="social fa fa-envelope"
        title="Email"></a>

      <a href="/feed.xml" class="social fa fa-rss" title="RSS feed"
        target="_blank"></a>
    </div>

    <p>&copy; 2019. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Ruby on Rails: Setup multiple associations with the same model</h1>
  <span class="post-date">04 Apr 2018</span>
  <br/>
  <p>When I was just starting to learn Ruby on Rails, I had trouble setting up
multiple associations with the same model due to my lack of understanding and
reliance on Rail’s “magical” generators. Here I’ll show you how to implement it
and analyze how it happens. On this example there are two models, User and
TransferRequest. TransferRequest has attributes sender and receiver which are
instances of User.</p>

<p>User was generated by executing the command:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Generates a User model.</span>
rails g model User name</code></pre></figure>

<p>The User model will look like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/models/transfer_request.rb</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span></code></pre></figure>

<p>Lets generate the TransferRequest model by executing the command:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Generates a TransferRequest model</span>
rails g model TransferRequest sender:references receiver:references</code></pre></figure>

<p>The code for TransferRequest should look like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/models/transfer_request.rb</span>
<span class="k">class</span> <span class="nc">TransferRequest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:sender</span>
  <span class="n">belongs_to</span> <span class="ss">:receiver</span>
<span class="k">end</span></code></pre></figure>

<p>A migration file to create the table for TransferRequest will also be generated.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># db/migrations/20180404063005_create_transfer_requests.rb</span>
<span class="k">class</span> <span class="nc">CreateTransferRequests</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:transfer_requests</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:sender</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:receiver</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Lets run a migration to apply the changes to our database.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">rails db:migrate <span class="c"># rake db:migrate if using Rails 4 and below.</span></code></pre></figure>

<p>When I was new to Ruby on Rails, I thought this would be enough to setup the
model TransferAsset and its association with <strong>sender</strong> and <strong>receiver</strong>.</p>

<p>Lets write a unit test that checks the <strong>belongs_to</strong> association but before
that lets first install the
<a href="https://github.com/thoughtbot/shoulda-matchers">shoulda-matchers</a> gem. Add
these to your Gemfile:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'shoulda'</span><span class="p">,</span> <span class="s1">'~&gt; 3.5'</span>
  <span class="n">gem</span> <span class="s1">'shoulda-matchers'</span><span class="p">,</span> <span class="s1">'~&gt; 2.0'</span>
<span class="k">end</span></code></pre></figure>

<p>Lets now write our unit test for the TransferRequest model. It should look like
the code below:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># test/models/transfer_request_test.rb</span>
<span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">TransferRequestTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">should</span> <span class="n">belong_to</span> <span class="ss">:sender</span>
  <span class="n">should</span> <span class="n">belong_to</span> <span class="ss">:receiver</span>
<span class="k">end</span></code></pre></figure>

<p>Now the run the test to check if the association was set up properly. Run the
command below.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">rails <span class="nb">test</span></code></pre></figure>

<p>The test will fail.</p>

<p>Lets analyze how this happened by first looking at the CreateTransferRequest
migration file and the changes it contributed to the <strong>db/schema.rb</strong> file after
running the migration. Running the migration modifies the <strong>db/schema.rb</strong>. This
piece of code will be added to it. Take note of the last two lines on the code
below.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># db/schema.rb</span>
<span class="n">create_table</span> <span class="s2">"transfer_requests"</span><span class="p">,</span> <span class="ss">force: :cascade</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="s2">"sender_id"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="s2">"receiver_id"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="p">[</span><span class="s2">"receiver_id"</span><span class="p">],</span> <span class="ss">name: </span><span class="s2">"index_transfer_requests_on_receiver_id"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="p">[</span><span class="s2">"sender_id"</span><span class="p">],</span> <span class="ss">name: </span><span class="s2">"index_transfer_requests_on_sender_id"</span>
<span class="k">end</span>

<span class="n">add_foreign_key</span> <span class="s2">"transfer_requests"</span><span class="p">,</span> <span class="s2">"sender"</span>
<span class="n">add_foreign_key</span> <span class="s2">"transfer_requests"</span><span class="p">,</span> <span class="s2">"receiver"</span></code></pre></figure>

<p>This instructs Rails Active Record to create the table <strong>tansfer_request</strong> with
columns <strong>sender_id</strong> and <strong>receiver_id</strong> which is represented by
TransferRequest as a model. The last two lines call the method
<strong>add_foreign_key</strong> which takes a table where the foreign keys reside as the
first argument and another table that will be references by the foreign key as
the second argument. Because of this Rails assumes that a table called
<strong>sender</strong> and <strong>receiver</strong> actually exists which
isn’t true.</p>

<p>To fix this, we need to remove the last two lines on our code snippet to prevent
Rails from referencing the tables that don’t exist however we can’t just remove
the last two lines on the <strong>db/schema.rb</strong> because it will be inconsistent with
our migration file. We need to modify the CreateTransferRequest migration but
before that we must undo some changes to the database by rolling it back to the
state where the <strong>transfer_request</strong> table doesn’t exist. Execute the command
below to revert the last migration and undo the changes to the databse.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">rails</span> <span class="n">db</span><span class="ss">:migrate</span> <span class="c1"># rake db:migrate if using Rails 4 and below.</span></code></pre></figure>

<p>This would revert the database and the <strong>db/schema.rb</strong> file to its previous
state. On the CreateTransferRequest migration file the value of the
<strong>foreign_key</strong> should be false or we can just ommit the part where the
<strong>foreign_key</strong> is passed since it is false by default like the code below.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># db/migrations/20180404063005_create_transfer_requests.rb</span>
<span class="k">class</span> <span class="nc">CreateTransferRequests</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:transfer_requests</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:sender</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:receiver</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Now lets run the migration again.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">rails db:migrate <span class="c"># Same as rake db:migrate</span></code></pre></figure>

<p>The <strong>db/schema.rb</strong> should be appended with the code below. It is expected not to
call the <strong>add_foreign_key</strong> method.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># db/schema.rb</span>
<span class="n">create_table</span> <span class="s2">"transfer_requests"</span><span class="p">,</span> <span class="ss">force: :cascade</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="s2">"sender_id"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="s2">"receiver_id"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="p">[</span><span class="s2">"receiver_id"</span><span class="p">],</span> <span class="ss">name: </span><span class="s2">"index_transfer_requests_on_receiver_id"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="p">[</span><span class="s2">"sender_id"</span><span class="p">],</span> <span class="ss">name: </span><span class="s2">"index_transfer_requests_on_sender_id"</span>
<span class="k">end</span></code></pre></figure>

<p>TransferRequest still doesn’t know that its attributes <strong>sender</strong> and
<strong>receiver</strong> are instances of User so we pass <strong>class_name: ‘User’</strong> as an
argument to the method <strong>belongs_to</strong> at the TransferRequest model.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/models/transfer_request.rb</span>
<span class="k">class</span> <span class="nc">TransferRequest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:sender</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'User'</span>
  <span class="n">belongs_to</span> <span class="ss">:receiver</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'User'</span>
<span class="k">end</span></code></pre></figure>

<p>User doesn’t know that it has many senders and receivers. Both from the table
<strong>transfer_request</strong>. Modify the User model to associate it with TransferRequest.
The User should look like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/models/user.rb</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:sender_transfer_request</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'TransferRequest'</span><span class="p">,</span>
    <span class="ss">foreign_key: </span><span class="s1">'sender_id'</span>
  <span class="n">has_many</span> <span class="ss">:receiver_transfer_request</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'TransferRequest'</span><span class="p">,</span>
    <span class="ss">foreign_key: </span><span class="s1">'receiver_id'</span>

  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre></figure>

<p>Here the method <strong>has_many</strong> was called passing a symbol ending with
<strong>_transfer_request</strong> as the first argument following the naming convention for
Active Record association. The second argument tells Rails that it is an
instance of TranferRequest. The third argument specifies which the column of the
of the table <strong>transfer_request</strong> is the foreign key.</p>

<p>If you run the test now then it would succeed.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/removing-git-submodules">
            How to remove Git submodules.
            <small>11 Oct 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/how-to-use-a-self-signed-certificate-with-gradle">
            How to use a self signed certificate with Gradle
            <small>29 Jul 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/how-to-enable-internet-access-on-centos7-virtualbox">
            How to enable internet access of CentOS 7 on VirtualBox
            <small>13 Jun 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


  <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://emmanuel-corrales.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    </div>

  </body>
</html>
