<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      NodeJS: Debugging and fixing HTTPS/SSL issues caused by changing the self signed certificate. | Emmanuel Corrales
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/poole.css">
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/syntax.css">
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/hyde.css">
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/cheatsheet.css">
  <link rel="stylesheet" href="https://emcorrales.com/assets/css/sidebar.css">
  
    <link rel="stylesheet" href="https://emcorrales.com/assets/css/posts.css">
  
  <link rel="stylesheet" href="https://emcorrales.com/vendor/font-awesome/5.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="57x57" href="https://emcorrales.com/assets/images/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://emcorrales.com/assets/images/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://emcorrales.com/assets/images/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://emcorrales.com/assets/images/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://emcorrales.com/assets/images/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://emcorrales.com/assets/images/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://emcorrales.com/assets/images/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://emcorrales.com/assets/images/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://emcorrales.com/assets/images/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="https://emcorrales.com/assets/images/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://emcorrales.com/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://emcorrales.com/assets/images/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://emcorrales.com/assets/images/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="https://emcorrales.com/assets/images/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://emcorrales.com/feed.xml">

  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-80537045-1', 'auto');
    ga('send', 'pageview');
  </script>
  

  <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>NodeJS: Debugging and fixing HTTPS/SSL issues caused by changing the self signed certificate. | Emmanuel Corrales</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="NodeJS: Debugging and fixing HTTPS/SSL issues caused by changing the self signed certificate." />
<meta name="author" content="Emmanuel Corrales" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This past month I’ve been bombarded with lots of issues regarding HTTPS/SSL. The internal Certificate Authority of the company I’m servicing recently changed their root certicate. This caused the services that communicate with other services in their network through HTTPS/SSL to break and receive errors. I’ve been debugging a NodeJS app that is being plagued by these issues. In this post I’ll show you the steps I took to fix this." />
<meta property="og:description" content="This past month I’ve been bombarded with lots of issues regarding HTTPS/SSL. The internal Certificate Authority of the company I’m servicing recently changed their root certicate. This caused the services that communicate with other services in their network through HTTPS/SSL to break and receive errors. I’ve been debugging a NodeJS app that is being plagued by these issues. In this post I’ll show you the steps I took to fix this." />
<link rel="canonical" href="https://emcorrales.com/blog/nodejs-debugging-and-fixing-https-ssl-issues-caused-by-changing-the-self-signed-certificate" />
<meta property="og:url" content="https://emcorrales.com/blog/nodejs-debugging-and-fixing-https-ssl-issues-caused-by-changing-the-self-signed-certificate" />
<meta property="og:site_name" content="Emmanuel Corrales" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-30T00:30:00+00:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Emmanuel Corrales"},"description":"This past month I’ve been bombarded with lots of issues regarding HTTPS/SSL. The internal Certificate Authority of the company I’m servicing recently changed their root certicate. This caused the services that communicate with other services in their network through HTTPS/SSL to break and receive errors. I’ve been debugging a NodeJS app that is being plagued by these issues. In this post I’ll show you the steps I took to fix this.","headline":"NodeJS: Debugging and fixing HTTPS/SSL issues caused by changing the self signed certificate.","dateModified":"2019-04-30T00:30:00+00:00","datePublished":"2019-04-30T00:30:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://emcorrales.com/blog/nodejs-debugging-and-fixing-https-ssl-issues-caused-by-changing-the-self-signed-certificate"},"url":"https://emcorrales.com/blog/nodejs-debugging-and-fixing-https-ssl-issues-caused-by-changing-the-self-signed-certificate","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <img src="https://www.gravatar.com/avatar/6b917878b9fccb87c8b1489813b755e2?s=500" alt="Emmanuel Corrales" />
      <h1>
        <a href="https://emcorrales.com">
          Emmanuel Corrales
        </a>
      </h1>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="https://emcorrales.com">Blog</a>

      

      
      
        
      
        
          
        
      
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/cheatsheets">Cheat Sheets</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about">About</a>
          
        
      
    </nav>

    <div class="social-icons">
      <a href="https://twitter.com/em_corrales"
        class="social fab fa-twitter" title="Twitter" target="_blank"></a>

      <a href="https://linkedin.com/in/emmanuelcorrales"
        class="social fab fa-linkedin" title="Linkedin" target="_blank"></a>

      <a href="https://github.com/emcorrales"
        class="social fab fa-github" title="Github" target="_blank"></a>

      <a href="mailto:contact@emcorrales.com" class="social fa fa-envelope"
        title="Email"></a>

      <a href="/feed.xml" class="social fa fa-rss" title="RSS feed"
        target="_blank"></a>
    </div>

    <p>&copy; 2019. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">NodeJS: Debugging and fixing HTTPS/SSL issues caused by changing the self signed certificate.</h1>
  <span class="post-date">30 Apr 2019</span>
  <br/>
  <p>This past month I’ve been bombarded with lots of issues regarding HTTPS/SSL.
The internal Certificate Authority of the company I’m servicing recently changed
their root certicate. This caused the services that communicate with other
services in their network through HTTPS/SSL to break and receive errors. I’ve
been debugging a NodeJS app that is being plagued by these issues. In this post
I’ll show you the steps I took to fix this.</p>

<p><img src="https://images.emcorrales.com/NodeJS-SSL-old-architecture.png" alt="alt text" title="The NodeJs app that depend on a third party app broke after changing certificate" /></p>

<p>The image above shows that the NodeJS app uses an API on their internal network.
The NodeJS app is the client of the third party API and is having trouble getting
a response through HTTPS even though the admin has installed the latest
certificate on every server’s trust store and is ready for use.</p>

<h3 id="checking-if-the-certificate-is-installed-on-the-server">Checking if the certificate is installed on the server.</h3>
<p>The first thing I did is to check if the new certificate is installed on the
server of the client app. I looked for the directory where the certificates are
stored:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl version <span class="nt">-d</span>
OPENSSLDIR: <span class="s2">"/usr/lib/ssl"</span>
</code></pre></div></div>
<p>then I looked for the certifcate in that directory. Below is the command I used
to look for a certificate called <em>example.pem</em>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> /usr/lib/ssl/certs | <span class="nb">grep </span>example.pem
</code></pre></div></div>

<h3 id="verifying-the-connection-to-the-third-party-api">Verifying the connection to the third party API.</h3>
<p>I needed to figure out if there is a problem with the new certificate. The first
thing that comes to my mind is to check if I can establish a HTTPS connection
with the third party API so I executed this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl s_client <span class="nt">-connect</span> api.example.com:443
</code></pre></div></div>
<p>Once I verified the HTTPS/SSL connection with the third party API, I proceeded
to running the client app.</p>

<h3 id="running-the-client-app">Running the client app.</h3>
<p>The Node app I was debugging is too big and I just need to test the part that
uses the API so I created a simple app that uses the same API. This will
serve as proxy. Below are the contents of the file <em>client.js</em>. A simple
NodeJS app that uses the third party API.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// client.js</span>
<span class="kd">const</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'https'</span><span class="p">);</span>

<span class="nx">https</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://api.example.com"</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`Expected 200, got </span><span class="p">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="p">});</span>
</code></pre></div></div>
<p>When I run the app I  get error messages like these:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node client.js
Error: unable to verify the first certificate
    at TLSSocket.onConnectSecure <span class="o">(</span>_tls_wrap.js:1036:34<span class="o">)</span>
    at TLSSocket.emit <span class="o">(</span>events.js:159:13<span class="o">)</span>
    at TLSSocket._finishInit <span class="o">(</span>_tls_wrap.js:637:8<span class="o">)</span>
</code></pre></div></div>
<p>The app is having verification errors with the API’s certificate because Node
doesn’t load the corresponding certificate that can verify it when creating a
 HTTPS request. The new certificate is installed on the server’s trust store but
Node doesn’t use it because it already has a default list of CA’s built into its
<a href="https://github.com/joyent/node/blob/master/src/node_root_certs.h">source</a>.
Thus, while it is true that it doesn’t do a lookup on the system hosted CA’s
and that there is no “store” per se, there is a default list of CA’s that it
accepts.</p>

<p>In order to use the new certificate, the app must be configured to load the CA
upon deployment by passing the environment variable <strong>NODE_EXTRA_CA_CERTS</strong> like
this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">NODE_EXTRA_CA_CERTS</span><span class="o">=</span>/usr/lib/ssl/certs node client.js Hello, world
</code></pre></div></div>
<p>This time the app will no longer show an error because it knows where to find
the new certificate.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/removing-git-submodules">
            How to remove Git submodules.
            <small>11 Oct 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/how-to-use-a-self-signed-certificate-with-gradle">
            How to use a self signed certificate with Gradle
            <small>29 Jul 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/how-to-enable-internet-access-on-centos7-virtualbox">
            How to enable internet access of CentOS 7 on VirtualBox
            <small>13 Jun 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


  <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://emmanuel-corrales.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    </div>

  </body>
</html>
